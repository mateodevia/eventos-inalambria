version: v1.0
name: Tests
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
  containers:
    - name: main
      image: 'registry.semaphoreci.com/node:12'
    - name: db
      image: 'registry.semaphoreci.com/postgres:9.6'
      env_vars:
        - name: POSTGRES_PASSWORD
          value: postgres
        - name: DB_NAME
          value: nplat_test
    - name: cache
      image: 'registry.semaphoreci.com/redis:5.0'
blocks:
  - name: Runtime Environment
    task:
      jobs:
        - name: DB + Redis
          commands:
            - apt-get -y update && apt-get install postgresql-client redis-tools
            - PGPASSWORD="postgres" createdb -U postgres -h db -p 5432 $DB_NAME
            - redis-cli -h cache "KEYS *"
  - name: Code build
    task:
      jobs:
        - name: npm install + npm start
          commands:
            - apt-get -y update && apt-get install postgresql-client redis-tools
            - PGPASSWORD="postgres" createdb -U postgres -h db -p 5432 $DB_NAME
            - redis-cli -h cache "KEYS *"
      env_vars:
        - name: DB_HOSTNAME
          value: db
