version: v1.0
name: Tests
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
  containers:
    - name: main
      image: 'registry.semaphoreci.com/ruby:2.6'
    - name: db
      image: 'registry.semaphoreci.com/postgres:9.6'
      env_vars:
        - name: POSTGRES_PASSWORD
          value: keyboard-cat
    - name: cache
      image: 'registry.semaphoreci.com/redis:5.0'
blocks:
  - name: Initialize Docker Containers
    task:
      jobs:
        - name: Hello
          commands:
            - apt-get -y update && apt-get install postgresql-client redis-tools
            - PGPASSWORD="keyboard-cat" createdb -U postgres -h db -p 5432
            - redis-cli -h cache "KEYS *"
  - name: Initialize server
    task:
      jobs:
        - name: 'Job #1'
          commands:
            - npm install
